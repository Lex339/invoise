<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è«‹æ±‚æ›¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 40px; max-width: 900px; margin: auto; }
    #seal { width: 80px; opacity: 0.85; display: none; margin-left: 10px; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 8px; }
    input[type="text"], input[type="number"], input[type="date"] { width: 100%; box-sizing: border-box; }
    .title { font-size: 28px; font-weight: bold; margin-bottom: 20px; text-align: center; }
    .issuer-box { display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; }
    .issuer-details { display: flex; align-items: flex-start; gap: 12px; }
    .issuer-grid { display: grid; grid-template-columns: 140px 1fr; gap: 6px 12px; align-items: center; min-width: 420px; }
    .left-total { font-size: 18px; font-weight: bold; min-width: 260px; }
    fieldset { border: 1px solid #ccc; padding: 12px; margin: 18px 0; }
    legend { padding: 0 6px; font-weight: bold; }
    .row { display: grid; grid-template-columns: 140px 1fr 140px 1fr; gap: 8px 12px; align-items: center; }
    .no-wrap { white-space: nowrap; }

    /* â–¼ è¿½åŠ ï¼šå¤–ç¨/å†…ç¨ã®2ã‚«ãƒ©ãƒ åˆè¨ˆè¡¨ç¤º */
    .totals-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .totals-col { border: 1px solid #ccc; padding: 10px; }
    .totals-title { font-weight: bold; margin-bottom: 6px; }

    /* A4ç¸¦ & ä½™ç™½ï¼ˆå°‘ã—ã ã‘è©°ã‚ã‚‹ï¼‰ */
    @page { size: A4 portrait; margin: 10mm; }

    /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå‰å›ã©ãŠã‚Šï¼‹2ã‚«ãƒ©ãƒ ã‚‚æœ‰åŠ¹ï¼‰ */
    @media print {
      .no-print, .no-print * { display: none !important; }
      input, button { appearance: none; }
      body { padding: 0 !important; }

      table, thead, tbody, tr, td, th, fieldset, .no-break {
        break-inside: avoid; page-break-inside: avoid;
      }

      .title { font-size: 22px; margin-bottom: 12px; }
      fieldset { margin: 12px 0; }
      legend { font-size: 0.95em; }

      /* ãƒ™ãƒ¼ã‚¹ç¸®å°ï¼ˆ90%ï¼‰ */
      #sheet { font-size: 0.90em; line-height: 1.25; }
      #sheet table td, #sheet table th { padding: 5px; }

      /* ã•ã‚‰ã«è¶³ã‚Šãªã‘ã‚Œã°æ®µéšçš„ã«ç¸®å°ï¼ˆbeforeprintã§è‡ªå‹•ä»˜ä¸ï¼‰ */
      .print-fit-85 #sheet { font-size: 0.85em; }
      .print-fit-85 #sheet table td, .print-fit-85 #sheet table th { padding: 4px; }

      .print-fit-80 #sheet { font-size: 0.80em; }
      .print-fit-80 #sheet table td, .print-fit-80 #sheet table th { padding: 3px; }

      .print-fit-75 #sheet { font-size: 0.75em; }
      .print-fit-75 #sheet table td, .print-fit-75 #sheet table th { padding: 2px; }

      #items { table-layout: fixed; }
      #items td, #items th { line-height: 1.2; }
    }
  </style>
</head>
<body>
  <div id="sheet">
    <div class="title">è«‹æ±‚æ›¸</div>

    <div class="issuer-box">
      <div class="left-total">åˆè¨ˆé‡‘é¡ï¼ˆæ¶ˆè²»ç¨è¾¼ï¼‰: <span id="total">0</span> å††</div>
      <div class="issuer-details">
        <div class="issuer-grid">
          <label for="issuer">ç™ºè¡Œè€…ï¼ˆè‡ªåˆ†ï¼‰</label><input type="text" id="issuer" placeholder="åå‰ãƒ»ä¼šç¤¾åãªã©">
          <label for="address">ä½æ‰€</label><input type="text" id="address" placeholder="ä½æ‰€">
          <label for="phone">é›»è©±ç•ªå·</label><input type="text" id="phone" placeholder="ä¾‹: 03-1234-5678">
          <label for="regno">ç™»éŒ²ç•ªå·</label><input type="text" id="regno" placeholder="ä¾‹: T1234567890123">
        </div>
        <img id="seal" alt="é›»å­å°é‘‘">
      </div>
    </div>

    <fieldset>
      <legend>è«‹æ±‚æƒ…å ±</legend>
      <div class="row">
        <label for="client">è«‹æ±‚å…ˆ</label><input type="text" id="client" placeholder="å–å¼•å…ˆå">
        <label for="date">è«‹æ±‚æ—¥</label><input type="date" id="date">
      </div>
    </fieldset>

    <!-- ç¨ç‡/ãƒ¢ãƒ¼ãƒ‰ã¯å°åˆ·æ™‚ã¯éè¡¨ç¤º -->
    <fieldset class="no-print">
      <legend>æ¶ˆè²»ç¨è¨­å®šï¼ˆå…±é€šç¨ç‡ãƒ»è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰</legend>
      <div class="row" style="grid-template-columns: 140px 1fr;">
        <label class="no-wrap" for="taxRate">ç¨ç‡</label>
        <div><input type="number" id="taxRate" value="10" min="0" step="0.1" oninput="updateTotal()"> %</div>
      </div>
      <label style="display:block; margin-top:8px;">
        <input type="checkbox" id="simpleInclusive" onchange="updateTotal()">
        å†…ç¨ã‚’ã€Œç¨è¾¼ Ã— ç¨ç‡ã€ã§è¡¨ç¤ºã™ã‚‹ï¼ˆç°¡æ˜“ãƒ¢ãƒ¼ãƒ‰ï¼è¡¨ç¤ºã®ã¿ï¼‰
      </label>
    </fieldset>

    <h2>è«‹æ±‚å†…å®¹</h2>
    <table id="items">
      <thead>
        <tr>
          <th style="width:34%">å“ç›®</th>
          <th style="width:14%">å˜ä¾¡</th>
          <th style="width:12%">æ•°é‡</th>
          <th style="width:14%">ç¨åŒºåˆ†</th>
          <th style="width:14%">å°è¨ˆ</th>
          <th style="width:12%"></th>
        </tr>
      </thead>
      <tbody id="item-body"></tbody>
    </table>
    <button onclick="addItem()" class="no-print">ï¼‹é …ç›®ã‚’è¿½åŠ </button>
    <button onclick="addGasolineItem()" class="no-print">ï¼‹ã‚¬ã‚½ãƒªãƒ³é …ç›®ã‚’è¿½åŠ </button>

    <fieldset class="no-print">
      <legend>é›»å­å°é‘‘ã®ä½œæˆ</legend>
      <div class="row" style="grid-template-columns: 140px 1fr;">
        <label for="sealName">å°é‘‘ã®åå‰</label>
        <input type="text" id="sealName" placeholder="ä¾‹: å±±ç”°" maxlength="4">
      </div>
      <button onclick="generateSeal()">ãƒãƒ³ã‚³ã‚’ä½œæˆã—ã¦æŠ¼ã™</button>
    </fieldset>

    <!-- å£åº§æƒ…å ±ã¯å¿…é ˆãªã®ã§å°åˆ·ã§ã‚‚å‡ºã™ -->
    <fieldset>
      <legend>æŒ¯è¾¼å…ˆï¼ˆéŠ€è¡Œå£åº§ï¼‰</legend>
      <div class="row">
        <label for="bankName">éŠ€è¡Œå</label><input type="text" id="bankName" placeholder="ä¾‹: ã€‡ã€‡éŠ€è¡Œ">
        <label for="branchName">æ”¯åº—å</label><input type="text" id="branchName" placeholder="ä¾‹: æœ¬åº—å–¶æ¥­éƒ¨">
        <label for="acctType">å£åº§ç¨®åˆ¥</label><input type="text" id="acctType" placeholder="ä¾‹: æ™®é€š / å½“åº§">
        <label for="acctNumber">å£åº§ç•ªå·</label><input type="text" id="acctNumber" placeholder="ä¾‹: 1234567">
        <label for="acctHolder">å£åº§åç¾©</label><input type="text" id="acctHolder" placeholder="ä¾‹: ã‚«ï¼‰ãƒ¤ãƒãƒ€ã‚·ãƒ§ã‚¦ã‚¸">
      </div>
    </fieldset>

    <!-- â–¼ åˆè¨ˆï¼šå¤–ç¨ï¼ˆå·¦ï¼‰ãƒ»å†…ç¨ï¼ˆå³ï¼‰ã®2ã‚«ãƒ©ãƒ ã«å¤‰æ›´ -->
    <h2>è«‹æ±‚åˆè¨ˆ</h2>
    <fieldset class="totals-grid">
      <div class="totals-col">
        <div class="totals-title">å¤–ç¨ï¼ˆç¨æŠœå˜ä¾¡ã®æ˜ç´°ï¼‰</div>
        <p>å°è¨ˆï¼ˆç¨æŠœï¼‰: <span id="exSubtotal">0</span> å††</p>
        <p>æ¶ˆè²»ç¨(<span id="taxRateView">10</span>%): <span id="exTax">0</span> å††</p>
        <p>å°è¨ˆï¼ˆç¨è¾¼ï¼‰: <span id="exTotal">0</span> å††</p>
      </div>
      <div class="totals-col">
        <div class="totals-title">å†…ç¨ï¼ˆç¨è¾¼å˜ä¾¡ã®æ˜ç´°ï¼‰</div>
        <p>å°è¨ˆï¼ˆç¨è¾¼ï¼‰: <span id="inTotal">0</span> å††</p>
        <p>ã†ã¡æ¶ˆè²»ç¨: <span id="inTax">0</span> å††</p>
      </div>
    </fieldset>

    <p><strong>åˆè¨ˆï¼ˆæ”¯æ‰•é¡ï¼‰: <span id="total">0</span> å††</strong></p>

    <div class="no-print" style="display:flex; gap:8px;">
      <button onclick="window.print()">ğŸ–¨ å°åˆ·ãƒ»PDFå‡ºåŠ›</button>
    </div>
  </div>

  <canvas id="sealCanvas" width="120" height="120" style="display:none;"></canvas>

  <script>
    function addItem() {
      const tbody = document.getElementById('item-body');
      if (tbody.children.length >= 20) {
        alert('æ˜ç´°ã¯æœ€å¤§20é …ç›®ã¾ã§ã«ã—ã¦ãã ã•ã„ã€‚'); return;
      }
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" class="item-name"></td>
        <td><input type="number" class="item-price" value="0" step="1" onchange="updateTotal()"></td>
        <td><input type="number" class="item-qty" value="1" step="1" onchange="updateTotal()"></td>
        <td>
          <select class="item-tax" onchange="updateTotal()">
            <option value="exclusive" selected>å¤–ç¨</option>
            <option value="inclusive">å†…ç¨</option>
          </select>
        </td>
        <td class="item-subtotal">0</td>
        <td><button class="no-print" onclick="this.closest('tr').remove(); updateTotal();">å‰Šé™¤</button></td>
      `;
      tbody.appendChild(row);
      updateTotal();
    }

    function addGasolineItem() {
      const tbody = document.getElementById('item-body');
      if (tbody.children.length >= 20) {
        alert('æ˜ç´°ã¯æœ€å¤§20é …ç›®ã¾ã§ã«ã—ã¦ãã ã•ã„ã€‚'); return;
      }
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>ã‚¬ã‚½ãƒªãƒ³</td>
        <td><input type="number" class="item-price" value="0" step="1" onchange="updateTotal()"></td>
        <td><input type="number" class="item-qty" value="0" step="1" onchange="updateTotal()"></td>
        <td>
          <select class="item-tax" onchange="updateTotal()">
            <option value="exclusive" selected>å¤–ç¨</option>
            <option value="inclusive">å†…ç¨</option>
          </select>
        </td>
        <td class="item-subtotal">0</td>
        <td><button class="no-print" onclick="this.closest('tr').remove(); updateTotal();">å‰Šé™¤</button></td>
      `;
      tbody.appendChild(row);
      updateTotal();
    }

    function updateTotal() {
      const ratePct = parseFloat(document.getElementById('taxRate').value || '10');
      const rate = ratePct / 100;
      const rateView = document.getElementById('taxRateView');
      if (rateView) rateView.innerText = ratePct.toString();

      const simple = document.getElementById('simpleInclusive')?.checked;

      let exSubtotal = 0, exTax = 0, exTotal = 0;
      let inTotal = 0, inTaxCorrect = 0, inTaxSimple = 0;

      document.querySelectorAll('#item-body tr').forEach(row => {
        const price = parseFloat(row.querySelector('.item-price')?.value || '0');
        const qty   = parseFloat(row.querySelector('.item-qty')?.value   || '0');
        const mode  = row.querySelector('.item-tax')?.value || 'exclusive';
        const amount = price * qty;

        let rowTotal = 0;

        if (mode === 'exclusive') {
          const rowEx = amount;
          const rowTax = Math.round(rowEx * rate);
          rowTotal = rowEx + rowTax;
          exSubtotal += rowEx; exTax += rowTax; exTotal += rowTotal;
        } else {
          const taxCorrect = Math.round(amount * (rate / (1 + rate)));
          const taxSimple  = Math.round(amount * rate);
          inTotal += amount;
          inTaxCorrect += taxCorrect;
          inTaxSimple  += taxSimple;
          rowTotal = amount;
        }

        const cell = row.querySelector('.item-subtotal');
        if (cell) cell.innerText = Math.round(rowTotal).toString();
      });

      document.getElementById('exSubtotal').innerText = Math.round(exSubtotal);
      document.getElementById('exTax').innerText = Math.round(exTax);
      document.getElementById('exTotal').innerText = Math.round(exTotal);
      document.getElementById('inTotal').innerText = Math.round(inTotal);
      document.getElementById('inTax').innerText = Math.round(simple ? inTaxSimple : inTaxCorrect);

      const grand = Math.round(exTotal + inTotal);
      document.querySelectorAll('#total').forEach(el => el.innerText = grand);
    }

    function generateSeal() {
      const name = document.getElementById('sealName').value.trim();
      if (!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      const canvas = document.getElementById('sealCanvas');
      const ctx = canvas.getContext('2d');
      const sealImg = document.getElementById('seal');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath(); ctx.arc(60, 60, 38, 0, Math.PI * 2);
      ctx.strokeStyle = "red"; ctx.lineWidth = 3; ctx.stroke();
      const fontSize = 22, lineHeight = 24;
      ctx.fillStyle = "red"; ctx.font = `bold ${fontSize}px serif`;
      ctx.textAlign = "center"; ctx.textBaseline = "middle";
      const totalHeight = (name.length - 1) * lineHeight;
      const startY = 60 - totalHeight / 2;
      for (let i = 0; i < name.length; i++) ctx.fillText(name[i], 60, startY + i * lineHeight);
      sealImg.src = canvas.toDataURL(); sealImg.style.display = 'block';
    }

    /* === A4 1æšè‡ªå‹•ãƒ•ã‚£ãƒƒãƒˆï¼ˆãƒ¢ãƒã‚¤ãƒ«Safari/Chrome/Edgeå¯¾å¿œï¼‰ === */
    const MM_TO_PX = 96 / 25.4; // 1mm â‰’ 3.78px
    function printableHeightPx() { return (297 - (10 + 10)) * MM_TO_PX; } // ä¸Šä¸‹10mm
    function fitsOnePage() {
      const sheet = document.getElementById('sheet');
      return sheet ? sheet.scrollHeight <= printableHeightPx() : true;
    }
    function clearFitClasses() {
      document.documentElement.classList.remove('print-fit-85','print-fit-80','print-fit-75');
    }
    window.addEventListener('beforeprint', () => {
      clearFitClasses();
      if (!fitsOnePage()) document.documentElement.classList.add('print-fit-85');
      if (!fitsOnePage()) document.documentElement.classList.add('print-fit-80');
      if (!fitsOnePage()) document.documentElement.classList.add('print-fit-75');
    });
    window.addEventListener('afterprint', clearFitClasses);

    // åˆæœŸè¡Œ
    addItem();
    document.getElementById('taxRate').addEventListener('change', updateTotal);
  </script>
</body>
</html>
